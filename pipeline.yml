# Generated using halfpipe cli version 1.69.3
groups: []
resources:
- name: git
  type: git
  source:
    branch: master
    private_key: ((github.private_key))
    uri: git@github.com:springernature/halfpipe-docker-compose.git
- name: slack-notification
  type: slack-notification
  source:
    url: https://hooks.slack.com/services/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
- name: version
  type: semver
  source:
    bucket: halfpipe-io-semver
    driver: gcs
    json_key: ((gcr.private_key))
    key: engineering-enablement-halfpipe-docker-compose
- name: Docker Registry
  type: docker-image
  source:
    password: ((gcr.private_key))
    repository: eu.gcr.io/halfpipe-io/halfpipe-docker-compose
    username: _json_key
resource_types:
- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
    tag: v1.4.2
jobs:
- name: update version
  plan:
  - aggregate:
    - get: git
      trigger: true
  - put: version
    params:
      bump: minor
  on_failure:
    put: slack-notification
    params:
      channel: '#halfpipe-team'
      icon_url: https://concourse.halfpipe.io/public/images/favicon-failed.png
      text: The pipeline `$BUILD_PIPELINE_NAME` failed at `$BUILD_JOB_NAME`. <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME>
      username: Halfpipe
- name: docker-push
  serial: true
  plan:
  - aggregate:
    - get: git
      passed:
      - update version
    - get: version
      passed:
      - update version
      trigger: true
  - put: Docker Registry
    params:
      build: git
      build_args:
        ARTIFACTORY_PASSWORD: ((artifactory.password))
        ARTIFACTORY_URL: ((artifactory.url))
        ARTIFACTORY_USERNAME: ((artifactory.username))
      tag_as_latest: true
      tag_file: version/number
    attempts: 1
  on_failure:
    aggregate:
    - put: slack-notification
      params:
        channel: '#halfpipe-team'
        icon_url: https://concourse.halfpipe.io/public/images/favicon-failed.png
        text: The pipeline `$BUILD_PIPELINE_NAME` failed at `$BUILD_JOB_NAME`. <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME>
        username: Halfpipe

